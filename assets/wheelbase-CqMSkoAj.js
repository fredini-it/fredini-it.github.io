import{V as u,L as I,B as N,a as W,G as ae,M as ne}from"./render-DyqDjMaS.js";let f=[],R=[],P=null;const w={promise:null,mesh:null},ie=new ne({color:1710618,roughness:.5,metalness:.5,map:null,normalMap:null});async function le(){if(w.promise)return w.promise;const s=new ae;return w.promise=s.loadAsync("/assets/constructor/Tire_SK.glb").then(t=>{const r=t.scene.getObjectByProperty("type","Mesh")||t.scene.children.find(a=>a.isMesh);if(!r)throw new Error("No mesh found in Tire_SK.glb");if(!r.morphTargetDictionary||Object.keys(r.morphTargetDictionary).length!==7)throw new Error("Expected 7 morph targets in Tire_SK.glb");r.material=ie,r.rotation.set(-Math.PI/2,0,0),w.mesh=r}),w.promise}function C(s){const t=s.match(/(\d+)\/(\d+)R(\d+)/);if(!t)throw new Error(`Invalid tire size: ${s}`);const[r,a,v,_]=t.map(Number),x=v/100*a,M=_*25.4,p=(M+2*x)/2/1e3,g=M/2/1e3;return{overall_radius:p,rim_radius:g,width:a/1e3,width_mm:a,aspect:v,rim_in:_}}async function ce(s){const t=await fetch("/assets/data/cars.json");if(!t.ok)throw new Error(`Failed to fetch car data: ${t.status}`);const r=(await t.json()).find(a=>a.VIN===s);if(!r)throw new Error(`Car with VIN ${s} not found`);return r}async function he(s,t,r,a=32,v=null){console.log("createWheelbase called with vin:",t);const _=await ce(t);console.log("Car data fetched:",_);const{wheelbase:x,frontTrack:M,rearTrack:T,tire_OEM_F:p,tire_OEM_R:g,tire_custom_F:L,tire_custom_R:X,tire_model:H}=_;if(!x||!M||!T||p===void 0||g===void 0)return console.warn(`Car '${t}' missing required data`),null;const z=v??(H??"oem")==="custom",J=C(p),Q=C(g),Y=x/1e3,O=Math.sqrt(Y**2+(Q.overall_radius-J.overall_radius)**2);let $=p,j=g;if(z){if(L===void 0||X===void 0)return console.warn(`Car '${t}' missing custom tire data`),null;$=L,j=X}const b=C($),y=C(j),k=y.overall_radius-b.overall_radius,h=(Math.abs(k)>O?0:Math.sqrt(O**2-k**2))/2,B=M/2e3,G=T/2e3,Z=new u(-h,b.overall_radius,0),ee=new u(h,y.overall_radius,0),S=new u(-h,b.overall_radius,B),V=new u(-h,b.overall_radius,-B),q=new u(h,y.overall_radius,G),K=new u(h,y.overall_radius,-G);console.log("Removing existing frame meshes"),f.forEach(e=>s.remove(e)),f=[new I(new N().setFromPoints([S,V]),new W({color:65280})),new I(new N().setFromPoints([q,K]),new W({color:65280})),new I(new N().setFromPoints([Z,ee]),new W({color:16711680}))],console.log("Adding new frame meshes:",f.length),f.forEach(e=>s.add(e)),console.log("Cleaning up existing wheel meshes"),R.forEach(e=>{e.traverse(o=>{o.isMesh&&o.geometry&&o.geometry.dispose(),o.isMesh&&o.material&&(Array.isArray(o.material)?o.material.forEach(A=>A.dispose()):o.material.dispose())}),s.remove(e)}),R=[],console.log("Wheel meshes cleaned up");function U(e,o){const re=o.width_mm,te=o.aspect,se=o.rim_in,n=Math.min(1,Math.max(0,(re-100)/300)),i=Math.min(1,Math.max(0,(te-25)/75)),l=Math.min(1,Math.max(0,(se-10)/15)),c=e.morphTargetInfluences;c[0]=(1-n)*(1-i)*l,c[1]=(1-n)*i*(1-l),c[2]=(1-n)*i*l,c[3]=n*(1-i)*(1-l),c[4]=n*(1-i)*l,c[5]=n*i*(1-l),c[6]=n*i*l}const D=async(e,o,A,oe=!1)=>{await le();const F=w.mesh,m=F.clone(!0);U(m,A),m.position.copy(e),m.rotation.set(Math.PI/2,0,0),s.add(m),R.push(m);const d=F.clone(!0);U(d,A),d.position.copy(o),d.rotation.set(Math.PI/2,Math.PI,0),s.add(d),R.push(d)};console.log("Creating front axle wheels"),await D(S,V,b),console.log("Creating rear axle wheels"),await D(q,K,y),console.log("Wheelbase creation completed"),P&&P.forEach(e=>{r.remove(e)});const E={Frame:!0,Wheels:!0,UseCustom:z};return P=[r.add(E,"Frame").onChange(e=>f.forEach(o=>o.visible=e)),r.add(E,"Wheels").onChange(e=>R.forEach(o=>o.visible=e)),r.add(E,"UseCustom").onChange(async e=>await he(s,t,r,a,e))],f}export{he as createWheelbase};
